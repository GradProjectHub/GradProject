# 画像の保存

CloudStorageを使用する。
markersディレクトリ下に連番で保存する。

## セキュリティルール

```
// Firebaseストレージルールのバージョン指定
rules_version = '2';

// ストレージサービスの設定
service firebase.storage {
  // バケット（ストレージの容器）に対するルール
  match /b/{bucket}/o {
    // markersディレクトリ内の任意のファイル（{markerId}）に対するルール
    match /markers/{markerId} {
      // 読み取りルール
      allow read: if request.auth != null;
      // ↑ Firebase Authenticationで認証されているユーザーのみ
      // マーカー画像の読み取りを許可

      // 書き込みルール
      allow write: if false;
      // ↑ すべての書き込み操作（create, update, delete）を禁止
      // マーカー画像の追加・更新・削除はFirebase Console経由で
      // 開発者のみが実行可能
    }
  }
}
```
## Cloud Storage無料枠

無料枠であるsparkプランは以下の通り

>|   |   |   |
|---|---|---|
|GB（保存）|5GB|
|GB（ダウンロード）|1 GB/日|
|アップロード オペレーション|2 万/日|
|ダウンロード オペレーション|5 万/日|


# マーカー画像のユーザ設定

各ユーザごとの設定情報をRealtime Databaseに保持する。

## セキュリティルール

```
{
  "rules": {
    // ユーザーのマーカー設定を保存するルートパス
    "user_marker_settings": {
      // $uidは動的なユーザーID（Firebase Authenticationから取得したUID）
      "$uid": {
        // 読み取りルール
        ".read": "auth != null && auth.uid == $uid",
        // ↑ 認証されていて（auth != null）、
        // かつ自分のデータ（auth.uid == $uid）のみ読み取り可能

        // 書き込みルール
        ".write": "auth != null && auth.uid == $uid",
        // ↑ 認証されていて、かつ自分のデータのみ書き込み可能

        // アニメカテゴリーのバリデーション
        "anime": {
          ".validate": "newData.isString() && newData.val().matches(/^marker[1-9][0-9]*$/)"
          // ↑ 値が文字列で、かつ'marker'で始まり1以上の数字が続く形式のみ許可
          // 例：'marker1', 'marker2', 'marker10' など
        },

        // ドラマカテゴリーのバリデーション（アニメと同じルール）
        "drama": {
          ".validate": "newData.isString() && newData.val().matches(/^marker[1-9][0-9]*$/)"
        },

        // 映画カテゴリーのバリデーション（アニメと同じルール）
        "movie": {
          ".validate": "newData.isString() && newData.val().matches(/^marker[1-9][0-9]*$/)"
        }
      }
    }
  }
}
```

## Realtime Database無料枠

>|   |   |   |
|---|---|---|
|同時接続 |100|
|GB（保存）|1 GB|
|GB（ダウンロード）|10 GB/月|